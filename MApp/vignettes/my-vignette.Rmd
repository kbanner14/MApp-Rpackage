---
title: "MApp: Model Averaged posteriors plot"
author: "Katharine Banner"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
  fig_capation: yes
vignette: >
  %\VignetteIndexEntry{MApp: Model Averaged posteriors plot}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r setup, echo = FALSE}
devtools::load_all("..")
```

```{r echo = TRUE}
library(MApp)
```

The `MApp()` function works with lists of posterior draws and the `MApp.bms()` function works with `bma` objects. A quick introduction to Bayesian model averaging and details about the `bms()` function can be found in the `BMS` package vignette (`vignette("BMS")`). 

In brief, model averaging was developed as a predictive tool and its use has been recently extended to model averaging of partial regression coefficients across multiple models. The inference drawn from the latter application of model averaging typically results in explanations of "average effects" for each of the coefficients of interest. The main issue is that interpreting model averaged partial regression coefficients as "average effects" can be very misleading since their interpretations are not necessarily the same across models. Therefore, model avearging of partial regression coefficients almost never makes sense. `MApp` provides the user with a visual of how the model averaged posterior distributions are constructed. A detailed discussion of the rational behind the `MApp` plot can be found in _Model Averaging Partial Regression Coefficients: Considerations and Practical Guidelines_, (Banner & Higgs, 2015). With two examples, we illustrate the utility of the plotting function as well as other useful functions in our package. 

## Example 1: using `MApp.bms()`

We will use the `brainData` in this package, which were obtained from the `case0902` dataset from the `Sleuth2` package. The data are comprised of average values for log gestation length log(days), litter size (number of offspring), log body size log(kg) and log brain weight log(g) for 96 species of mammals. 

```{r, brain, results='asis'}
data(brainData)
knitr::kable(head(brainData, 5))
```

We can use the `bms` function from the `BMS` package to obtain a `bma` object. 

```{r bmsobj}
library(BMS)
brain <- bms(brainData, g = "UIP", 
                    mprior = "uniform", 
                    user.int = F)
class(brain)
```

`bms` places Zellner's $g$-prior on the coefficients and we specify a discrete uniform prior on the  $2^3=$ `r 2^3` models in the model set, where the model set is defined by all first order combinations of the potential covariates (see `help(bms)` and `vignette("BMS")` for more details). Using `MApp.bms()` with an object generated by `bms()` is simple: 

```{r bmsfig, fig.show = 'hold', fig.width = 7, fig.height = 5, fig.cap="MApp for each explanatory variable in the dataset"}
MApp.bms(brain, plot.wind = c(1,3))
```

__Add some takeaways__ 

We can add specific model names in place of the generic $M_1, M_2,..., M_7$ with the `mod.names` arguement. 

```{r bmsfig2, fig.show = 'hold', fig.width = 7, fig.height = 5, fig.cap="MApp for each explanatory variable in the dataset"}
MApp.bms(brain, plot.wind = c(1,3), 
          mod.names = c("BGL", "BG", "BL", "B", "G", "GL", "L"))

```


## Example 2: Other options in `MApp.bms()`  

We will use the `bfat` data set, included in our package, to demonstrate the flexibility of our plotting function.

```{r, results='asis'}
data(bfat)
knitr::kable(head(bfat, 5))
fat.bms <- bms(bfat, mprior = "uniform", g = "UIP", user.int = F)
```

__Add details about `bma` object going into bms__ 

<!-- 
___CUT___
We will use the `sim.post.fun()` function to generate a list of posterior draws according to the unit informaiton formulation of Zellner's $g$-prior. This is an unecessary step since the user would already have these draws if they had written their own Gibbs sampler. 
```{r sim, results = 'asis', cache=TRUE}
# We use bms() to get the pieces we need....these would be obtained from 
# some other sampler if MApp is being used...


# save posteiror model probabilities from top 500 models
pmps <- topmodels.bma(fat.bms)[14, 1:500]

# top 500 account for ~97.5 % of posterior model mass
sum(pmps)

# save PIPs
results <- data.frame(coef(fat.bms))
PIP <- results[order(results$Idx), ][, 1]

# create input matrix (see Ex 1 above for details about inmat)
inmat <- fat.bms$topmod$betas()[, 1:500]
inmat[inmat != 0] <- 1
inmat <- t(inmat)

# create list of simulated 'draws' from each of the top 500 models 
bfat.sim <- sim.post.fun(inmat, Xmat = bfat[, -1], Yvec = bfat[, 1], num.sims = 1000)

# The simulation function creates a list
class(bfat.sim)

# there are simulated draws from the top 500 models
length(bfat.sim)

# We generated 1000 "posterior draws" for each of the 13 potential explanatory
# variables
dim(bfat.sim[[1]])

# Draws from the top model look like this.
knitr::kable(head(bfat.sim[[1]], 5))
```
--> 

When dealing with a large model set, we can tell `MApp.bms()` to display specific models. We can also specify which coefficient to include in the model averaged posteriors plot. By default, the function will plot all models and all coefficients. __Add sentence about the approximation when a bms object only stores info from top 500 models.__ 

<!--
```{r bfatplot ,fig.width=7, fig.height=5, results='asis'}
bfat.mapp <- MApp.bms(fat.bms, plot.wind = c(1,3), 
                        include.coef = c(13, 2, 4), 
                        max.display = 20, 
                        num.sims = 1000)

knitr::kable(bfat.mapp)
```
-->

## Example 3  Using MApp() 

___Maybe get rid of demonstrating simulation function, since it requires output from `bms`. Perhaps better to just show flexibility of MApp.bms function. Should simplify MAPP function so that it doesn't have to go through `sim.post.fun()` steps to use list of posterior draws...___

You may have wanted more flexibility in your model set, so you may have used `BUGS`, `OpenBUGS`, or programmed your own Gibbs sampler to search through the model space. In this case you will have many sets of posterior draws for the partial regression coefficients estimated by each of the models in your model set. Oftentimes this will be conveniently stored in a list of length equal to the cardinality of your model set. In this case, you can still create a Model Averaged posteriors plot using our function, you will just have to add a few more arguments. 


<!--
Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))

-->
